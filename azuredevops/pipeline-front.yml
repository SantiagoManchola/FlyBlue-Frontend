# =========================================================
# PIPELINE √öNICO CI/CD - FLYBLUE FRONTEND (VITE + REACT)
# =========================================================

trigger:
  branches:
    include:
      - dev
      - test
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: nodeVersion
    value: '18.x'
  - name: buildDir
    value: 'dist'
  - group: 'VG-FLYBLUE-FRONT'   # Variable Group correcto

stages:
  - stage: BuildAndDeploy
    displayName: 'Build & Deploy Frontend'
    jobs:

      # =====================================================
      # JOB 1 ‚Üí BUILD
      # =====================================================
      - job: Build
        displayName: 'Build Frontend (Vite + React)'
        steps:

          # Instalar Node
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Instalar Node.js'

          # Crear archivo .env.production din√°mico seg√∫n entorno
          - script: |
              if [ "$(Build.SourceBranch)" = "refs/heads/dev" ]; then
                echo "üîµ Configurando variables para DEV"
                echo "VITE_API_URL=https://flyblue-api-server-dev-g0a8bsfaethdehe0.canadacentral-01.azurewebsites.net" > .env.production
                echo "VITE_API_BASE_URL=https://polite-coast-0d3a3470f.3.azurestaticapps.net" >> .env.production
              
              elif [ "$(Build.SourceBranch)" = "refs/heads/test" ]; then
                echo "üü° Configurando variables para TEST"
                echo "VITE_API_URL=https://flyblue-api-server-test-gaheeyd2e7hybwau.canadacentral-01.azurewebsites.net" > .env.production
                echo "VITE_API_BASE_URL=https://white-glacier-0099a120f.3.azurestaticapps.net" >> .env.production
              
              else
                echo "üü¢ Configurando variables para MAIN (Producci√≥n)"
                echo "VITE_API_URL=https://flyblue-api-server-main-hzdma8gyhudag8bq.canadacentral-01.azurewebsites.net" > .env.production
                echo "VITE_API_BASE_URL=https://lively-tree-0af212b0f.3.azurestaticapps.net" >> .env.production
              fi
              
              echo "üìÑ Contenido de .env.production:"
              cat .env.production
            displayName: "Crear .env.production seg√∫n entorno"

          # Instalar dependencias
          - script: |
              npm install
            displayName: 'Instalar dependencias'

          # Compilar con variables de entorno
          - script: |
              echo "üîç Verificando .env.production antes del build:"
              cat .env.production
              npm run build
            displayName: 'Compilar con Vite'

          # Publicar artefacto dist
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/$(buildDir)'
              artifact: 'dist'
            displayName: 'Publicar artefacto compilado'

      # =====================================================
      # JOB 2 ‚Üí DEPLOY
      # =====================================================
      - job: Deploy
        displayName: 'Desplegar a Azure Static Web App'
        dependsOn: Build
        steps:

          # Descargar artefacto dist/
          - download: current
            artifact: dist

          # Seleccionar TOKEN seg√∫n rama
          - script: |
              echo "Branch detectada: $(Build.SourceBranch)"

              if [ "$(Build.SourceBranch)" = "refs/heads/dev" ]; then
                echo ">>> Deploy hacia DEV"
                echo "##vso[task.setvariable variable=DEPLOY_TOKEN]$(AZURE_STATIC_WEB_APP_TOKEN_DEV)"

              elif [ "$(Build.SourceBranch)" = "refs/heads/test" ]; then
                echo ">>> Deploy hacia TEST"
                echo "##vso[task.setvariable variable=DEPLOY_TOKEN]$(AZURE_STATIC_WEB_APP_TOKEN_TEST)"

              else
                echo ">>> Deploy hacia MAIN (Producci√≥n)"
                echo "##vso[task.setvariable variable=DEPLOY_TOKEN]$(AZURE_STATIC_WEB_APP_TOKEN_MAIN)"
              fi
            displayName: 'Seleccionar token seg√∫n la rama'

          # Deploy con artefacto pre-compilado
          - task: AzureStaticWebApp@0
            displayName: 'Deploy to Azure Static Web App'
            inputs:
              app_location: '$(Pipeline.Workspace)/dist'
              skip_app_build: true
              azure_static_web_apps_api_token: '$(DEPLOY_TOKEN)'
